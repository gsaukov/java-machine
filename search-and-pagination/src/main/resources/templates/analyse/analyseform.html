<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <link href="http://localhost:9020/static/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link href="http://localhost:9020/static/css/font-awesome.css" rel="stylesheet">
    <link href="http://localhost:9020/static/css/custom.css" rel="stylesheet" />
    <link href="http://localhost:9020/static/css/fontelloembedded.css" rel="stylesheet" />
    <link href="http://localhost:9020/static/css/simplebar.css" rel="stylesheet" />
    <link href="http://localhost:9020/static/css/ol.css" rel="stylesheet" >
    <link href="http://localhost:9020/static/css/auto-complete.css" rel="stylesheet" >

    <script src="http://localhost:9020/static/js/custom/AddressMap.js"></script>
    <script src="http://localhost:9020/static/js/custom/chart.js"></script>
    <script src="http://localhost:9020/static/js/custom/custom.js"></script>

    <script src="http://localhost:9020/static/js/external/jquery-3.3.1.min.js"></script>
    <script src="http://localhost:9020/static/js/external/popper.min.js" ></script>
    <script src="http://localhost:9020/static/js/external/bootstrap.min.js"></script>
    <script src="http://localhost:9020/static/js/external/simplebar.js"></script>
    <script src="http://localhost:9020/static/js/external/OpenLayers.js"></script>
    <script src="http://localhost:9020/static/js/external/OpenStreetMap.js"></script>
    <script src="http://localhost:9020/static/js/external/ol.js"></script>
    <script src="http://localhost:9020/static/js/external/auto-complete.js"></script>
    <script src="http://localhost:9020/static/js/external/d3.v5.js"></script>
</head>

<body>
    <div th:fragment="analyseform" style="float: right; position: relative;">
        <form id="analyseform" action="#" th:action="@{analysedomain/}" th:object="${analyseDomainRequest}" method="post">
            <fieldset class="form-group">
                <legend>Analyse domain</legend>
                <div class="row-container">
                    <select required id="domainSelector" initialized="false" th:field="*{domain}" class="form-control" onclick="populateDomains()" style="width: 8em; margin-left: 10px; margin-right: 10px;">
                        <option value="" style="color: #999999;">Domain...</option>
                    </select>
                    <select id="object" th:field="*{object}" class="form-control" style="width: 8em; margin-right: 10px;">
                        <option value="SYMBOL">SYMBOL</option>
                    </select>
                    <select id="size" th:field="*{size}" class="form-control" style="width: 5em; margin-right: 10px;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </fieldset>
        </form>
        <div class="row-container">
            <input type="submit" value="submit" onClick="if (document.getElementById('analyseform').reportValidity()){document.getElementById('pieChartButtonVolume').disabled=false; document.getElementById('pieChartButtonValue').disabled=true;} buildDomainPerformancePieChart('analyseform');" class="btn btn-default leftMerge" style="margin-left: 10px; width: 8em;"/>
            <button id="pieChartButtonVolume" onClick="PieChart.fill(PieChart.prepareData(jsonPieData, 'volume')); this.disabled=true; document.getElementById('pieChartButtonValue').disabled=false;" disabled class="btn btn-default middleMerge" style="width: 7em;">volume</button>
            <button id="pieChartButtonValue" onClick="PieChart.fill(PieChart.prepareData(jsonPieData, 'value')); this.disabled=true; document.getElementById('pieChartButtonVolume').disabled=false;" disabled class="btn btn-default rightMerge" style=" width: 7em;">value</button>
        </div>
        <div id="pieChartDataTable"></div>
        <script>
            function populateDomains() {
                let select = $("#domainSelector");
                if(select.attr('initialized')==="false"){
                    let onResponse = function (response) {
                        populateDomainOptions (JSON.parse(response));
                    }
                    doFetch("getalldomains", "GET", null, onResponse);
                }

                function populateDomainOptions (domainsOptions) {
                    if(select.attr('initialized')==="false"){
                        for (const el of domainsOptions) {
                            select.append($("<option/>").attr("value", el).text(el));
                        }
                        select.attr('initialized', "true")
                    }
                }
            }

            function buildDomainPerformancePieChart(formId) {
                removeAllChildren('domainperformance');
                $("#pieChartDataTable").empty();
                preBuildPieChart();
                let form = document.getElementById(formId);
                tryPreventDefault();
                if (form.reportValidity()) {
                    let onResponse = function (response) {
                        jsonPieData = response;
                        PieChart.fill(PieChart.prepareData(jsonPieData, 'value'));
                        $("#pieChartDataTable").html(buildHtmlTable(JSON.parse(jsonPieData)));

                    }
                    doFetch($(form).attr('action'), $(form).attr('method'), buildData($(form).get(0)), onResponse);
                }
            }

            // Builds the HTML Table out of myList json data from Ivy restful service.
            function buildHtmlTable(arr) {
                var _table_ = document.createElement('table'),
                    _tr_ = document.createElement('tr'),
                    _th_ = document.createElement('th'),
                    _td_ = document.createElement('td');
                var table = _table_.cloneNode(false),
                    columns = addAllColumnHeaders(arr, table, _tr_, _th_);
                for (var i=0, maxi=arr.length; i < maxi; ++i) {
                    var tr = _tr_.cloneNode(false);
                    for (var j=0, maxj=columns.length; j < maxj ; ++j) {
                        var td = _td_.cloneNode(false);
                        cellValue = arr[i][columns[j]];
                        td.appendChild(document.createTextNode(arr[i][columns[j]] || ''));
                        tr.appendChild(td);
                    }
                    table.appendChild(tr);
                }
                return table;
            }

            // Adds a header row to the table and returns the set of columns.
            // Need to do union of keys from all records as some records may not contain
            // all records
            function addAllColumnHeaders(arr, table, _tr_, _th_) {
                var columnSet = [],
                    tr = _tr_.cloneNode(false);
                for (var i=0, l=arr.length; i < l; i++) {
                    for (var key in arr[i]) {
                        if (arr[i].hasOwnProperty(key) && columnSet.indexOf(key)===-1) {
                            columnSet.push(key);
                            var th = _th_.cloneNode(false);
                            th.appendChild(document.createTextNode(key));
                            tr.appendChild(th);
                        }
                    }
                }
                table.appendChild(tr);
                return columnSet;
            }
        </script>
    </div>
</body>
</html>