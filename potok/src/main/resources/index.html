<!DOCTYPE html>
<html xmlns ="http://www.w3.org/1999/xhtml">
<head>
        
        <title>Demo Exchange</title>

	<style>
		body { 
			padding:20px;
		}
		#console { 
			height: 400px; 
			overflow: auto; 
		}
		.username-msg {color:orange;}
		.connect-msg {color:green;}
		.disconnect-msg {color:red;}
		.send-msg {color:#888}
	</style>

    <link href="http://localhost:9020/static/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link href="http://localhost:9020/static/css/custom.css" rel="stylesheet" />

    <script src="http://localhost:9020/static/js/custom/custom.js"></script>
    <script src="http://localhost:9020/static/js/external/jquery-3.3.1.min.js"></script>
	<script src="http://localhost:9020/static/js/external/socket.io.dev.js"></script>

	
	<script>

        // const socket = io('localhost:9092', { transports: ['websocket'], forceNew: true, path : ''})
        // Before creating wss ssl go visit this page in browser, to accept certificate other wise you will get
        // [#### canâ€™t establish a connection to the server at] Exception.

        const socket = io('https://localhost:9092',
                { transports: ['websocket'],
                    forceNew: true,
                    path : '',
                    secure: true,
                    rejectUnauthorized: false,
                    extraHeaders: {'x-clientid': 'bazooka'},
                    query : {'SESSIONID': 'NGZhMWE0OGEtOTdiZS00MjEyLWJhNTYtMDcwOTZiNGY1Y2Ji'},
                    upgrade: false
                });

		socket.on('connect', function() {
			output('<span class="connect-msg">Client has connected to the server!</span>');
		});
		
		socket.on('message', function(data) {
			output(data.line);
		});

        socket.on('quoteResponse', function(data) {
            buildBidAskTable(JSON.stringify(data));
        });

        socket.on('orderConfirm', function(data) {
            output(JSON.stringify(data));
            addOrderToTable(data);
        });

        socket.on('execution', function(data) {
            output(JSON.stringify(data));
            processExecution(data)
        });

        socket.on('balance', function(data) {
            processBalance(data)
        });

        socket.on('positionNotification', function(data) {
            processPositionTable(data)
        });
		
		socket.on('disconnect', function() {
			output('<span class="disconnect-msg">The client has disconnected!</span>');
		});

        function sendDisconnect() {
                socket.disconnect();
        }
		
		function sendMessage() {
                        var message = $('#msg').val();
                        $('#msg').val('');
                        
                        var jsonObject = {'@class': 'com.apps.potok.soketio.model.LogFile', line: message};
                        socket.emit('message', jsonObject);
		}

        function subscribe() {
            var message = $('#msg').val();
            $('#msg').val('');

            var jsonObject = {'@class': 'com.apps.potok.soketio.model.quote.QuoteRequest', symbol: message};
            socket.emit('quoteRequest', jsonObject);
        }

        function newOrder() {
            var symbol = $('#msg').val();
            var route = $('#rte').val();
            var volume = $('#vol').val();
            var price = $('#val').val();

            var newOrder = {
                '@class' : 'com.apps.potok.soketio.model.order.NewOrder',
                uuid : null,
                symbol : symbol,
                route : route,
                val : price ,
                volume : volume
            }

            socket.emit('newOrder', newOrder);
        }

        function cancelOrder() {
            var message = $('#msg').val();

            var jsonObject = {'@class': 'com.apps.potok.soketio.model.order.CancelOrder', uuid: message};
            socket.emit('cancelOrder', jsonObject);
        }

		function output(message) {
            var currentTime = "<span class='time'>" +  Date.now() + "</span>";
            var element = $("<div>" + currentTime + " " + message + "</div>");
			$('#console').prepend(element);
		}

        function buildBidAskTable(quoteResponse) {
            let quotes = JSON.parse(quoteResponse);
            let bidData = quotes.bidQuotes;
            let askData = quotes.askQuotes;
            let bidTable = buildHtmlTable(bidData);
            let askTable = buildHtmlTable(askData);
            $("#tradingWindowBidTable").html(bidTable);
            $("#tradingWindowAskTable").html(askTable);
        }

        function processPositionTable(position) {
            let row = document.getElementById('positionRow' + position.uuid);
            if (row === null) {
                addPositionToTable(position);
            } else {
                processPositionUpdate(position, row);
            }
        }

        function addPositionToTable(position) {
            var table = document.getElementById("positionTable");
            var row = table.insertRow(1);

            row.id = 'positionRow' + position.uuid;
            var uuid = row.insertCell(0);
            var createdTimestamp = row.insertCell(1);
            var symbol = row.insertCell(2);
            var account = row.insertCell(3);
            var volume = row.insertCell(4);
            var weightedAveragePrice = row.insertCell(5);
            var averagePerformance = row.insertCell(6);

            uuid.innerHTML = position.uuid;
            createdTimestamp.innerHTML = position.createdTimestamp;
            symbol.innerHTML = position.symbol;
            account.innerHTML = position.account;
            volume.innerHTML = position.volume;
            weightedAveragePrice.innerHTML = position.weightedAveragePrice;
            averagePerformance.innerHTML = position.averagePerformance;
        }

        function processPositionUpdate(execution, row) {
            var volume = row.cells[5];
            var weightedAveragePrice = row.cells[5];
            var averagePerformance = row.cells[6];

            volume.innerHTML = position.volume;
            weightedAveragePrice.innerHTML = position.weightedAveragePrice;
            averagePerformance.innerHTML = position.averagePerformance;
        }

        function addOrderToTable(newOrder) {
            var table = document.getElementById("orderTable");
            var row = table.insertRow(1);

            row.id = 'orderRow' + newOrder.uuid;
            var uuid = row.insertCell(0);
            var symbol = row.insertCell(1);
            var route = row.insertCell(2);
            var price = row.insertCell(3);
            var quantity = row.insertCell(4);
            var filled = row.insertCell(5);
            var left = row.insertCell(6);

            uuid.innerHTML = newOrder.uuid;
            symbol.innerHTML = newOrder.symbol;
            route.innerHTML = newOrder.route;
            price.innerHTML = newOrder.val;
            quantity.innerHTML = newOrder.volume;
            filled.innerHTML = 0;
            left.innerHTML = newOrder.volume;
        }

        function processExecution(execution) {
            var row = document.getElementById('orderRow' + execution.orderUuid);

            var filled = row.cells[5];
            var left = row.cells[6];

            filled.innerHTML = parseInt(filled.innerHTML) + parseInt(execution.quantity);
            left.innerHTML = parseInt(left.innerHTML) - parseInt(execution.quantity);
        }

        function processBalance(balance) {
            var balanceIndicator = document.getElementById('balanceIndicator');
            balanceIndicator.innerHTML = balance;
        }

        function readCookie(name) {
            var nameEQ = name + "=";
            var ca = document.cookie.split(';');
            for(var i=0;i < ca.length;i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1,c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
            }
            return null;
        }

	</script>
</head>

<body>

    <div class="row">
        <div class="col-12 col-md-9"><h2>Exchange</h2></div>
        <div class="col-6 col-md-3">
            <div class="row-container">
                <h2>Balance: </h2>
                <h2><div id="balanceIndicator"></div></h2>
            </div>
        </div>
    </div>

	<br/>

    <form class="well form-inline" onsubmit="return false;">
        <input id="msg" class="input-xlarge" type="text" placeholder="Symbol.."/>
        <input id="rte" class="input-xlarge" type="text" placeholder="Route..."/>
        <input id="vol" class="input-xlarge" type="text" placeholder="Volume..."/>
        <input id="val" class="input-xlarge" type="text" placeholder="Price..."/>
        <button type="button" onClick="sendMessage()" class="btn">Send</button>
        <button type="button" onClick="subscribe()" class="btn">Subscribe</button>
        <button type="button" onClick="sendDisconnect()" class="btn">Disconnect</button>
        <button type="button" onClick="newOrder()" class="btn">Order</button>
        <button type="button" onClick="cancelOrder()" class="btn">Cancel</button>
    </form>

    <div class="row-container" style="height: 500px">
        <div id="tradingWindowBidTable"></div>
        <div id="tradingWindowAskTable"></div>
    </div>

   <table id="positionTable" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
       <thead>
       <tr>
           <th class="th-sm">uuid</th>
           <th class="th-sm">createdTimestamp</th>
           <th class="th-sm">symbol</th>
           <th class="th-sm">account</th>
           <th class="th-sm">volume</th>
           <th class="th-sm">weightedAveragePrice</th>
           <th class="th-sm">averagePerformance</th>
       </tr>
       </thead>
       <tbody>

       </tbody>
   </table>

   <table id="orderTable" class="table table-striped table-bordered table-sm" cellspacing="0" width="100%">
        <thead>
        <tr>
            <th class="th-sm">UUID</th>
            <th class="th-sm">SYMBOL</th>
            <th class="th-sm">ROUTE</th>
            <th class="th-sm">PRICE</th>
            <th class="th-sm">QUANTITY</th>
            <th class="th-sm">FILLED</th>
            <th class="th-sm">LEFT</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <div id="console" class="well"/>
	
</body>

</html>
