<!DOCTYPE html>
<html xmlns ="http://www.w3.org/1999/xhtml">
<head>
        
        <title>Demo Exchange</title>

	<style>
		body { 
			padding:20px;
		}
		#console { 
			height: 400px; 
			overflow: auto; 
		}
		.username-msg {color:orange;}
		.connect-msg {color:green;}
		.disconnect-msg {color:red;}
		.send-msg {color:#888}
	</style>

    <link href="http://localhost:9020/static/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
    <link href="http://localhost:9020/static/css/custom.css" rel="stylesheet" />

    <script src="http://localhost:9020/static/js/custom/custom.js"></script>
    <script src="http://localhost:9020/static/js/external/jquery-3.3.1.min.js"></script>
	<script src="http://localhost:9020/static/js/external/socket.io.dev.js"></script>

	
	<script>

        var userName = 'user' + Math.floor((Math.random()*1000)+1);

        // const socket = io('localhost:9092', { transports: ['websocket'], forceNew: true, path : ''})
        // Before creating wss ssl go visit this page in browser, to accept certificate other wise you will get
        // [#### canâ€™t establish a connection to the server at] Exception.

        const socket = io('https://localhost:9092', { transports: ['websocket'], forceNew: true, path : '', secure: true, rejectUnauthorized: false});

		socket.on('connect', function() {
			output('<span class="connect-msg">Client has connected to the server!</span>');
		});
		
		socket.on('message', function(data) {
			output(data.line);
		});

        socket.on('quoteResponse', function(data) {
            buildBidAskTable(JSON.stringify(data));
        });
		
		socket.on('disconnect', function() {
			output('<span class="disconnect-msg">The client has disconnected!</span>');
		});

                function sendDisconnect() {
                        socket.disconnect();
                }
		
		function sendMessage() {
                        var message = $('#msg').val();
                        $('#msg').val('');
                        
                        var jsonObject = {'@class': 'com.apps.potok.soketio.model.LogFile', line: message};
                        socket.emit('message', jsonObject);
		}

        function subscribe() {
            var message = $('#msg').val();
            $('#msg').val('');

            var jsonObject = {'@class': 'com.apps.potok.soketio.model.quote.QuoteRequest', symbol: message};
            socket.emit('quoteRequest', jsonObject);
        }
		
		function output(message) {
            var currentTime = "<span class='time'>" +  Date.now() + "</span>";
            var element = $("<div>" + currentTime + " " + message + "</div>");
			$('#console').prepend(element);
		}

        function buildBidAskTable(quoteResponse) {
            let quotes = JSON.parse(quoteResponse);
            let bidData = quotes.bidQuotes;
            let askData = quotes.askQuotes.reverse();
            let bidTable = buildHtmlTable(bidData);
            let askTable = buildHtmlTable(askData);
            $("#tradingWindowBidTable").html(bidTable);
            $("#tradingWindowAskTable").html(askTable);
        }

	</script>
</head>

<body>
	
	<h1>Demo Exchange</h1>
	
	<br/>

    <form class="well form-inline" onsubmit="return false;">
        <input id="msg" class="input-xlarge" type="text" placeholder="Type something..."/>
        <button type="button" onClick="sendMessage()" class="btn">Send</button>
        <button type="button" onClick="subscribe()" class="btn">Subscribe</button>
        <button type="button" onClick="sendDisconnect()" class="btn">Disconnect</button>
    </form>

    <div class="row-container">
        <div id="tradingWindowBidTable"></div>
        <div id="tradingWindowAskTable"></div>
    </div>
	<div id="console" class="well"/>
    

	
</body>

</html>
